TODO: серьёзный рефакторинг (Разбить на пару классов и убрать утечки памяти в некоторых места)